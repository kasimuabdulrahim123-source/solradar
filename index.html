<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SolRadar ‚Äî Second Wave Hunter</title>
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@400;500&family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#04060d;--bg2:#080c18;--bg3:#0c1220;
  --border:#161f33;--border2:#1e2d47;
  --green:#0dff8c;--yellow:#ffc233;--red:#ff3d5a;
  --blue:#3d8eff;--purple:#9c5fff;--cyan:#00e5ff;
  --gold:#ffd700;--text:#dce8f5;--text2:#526180;--text3:#8a9ab5;
}
*{margin:0;padding:0;box-sizing:border-box;}
html,body{height:100%;overflow-x:hidden;}
body{font-family:'Manrope',sans-serif;background:var(--bg);color:var(--text);}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(0,229,255,0.012) 1px,transparent 1px),linear-gradient(90deg,rgba(0,229,255,0.012) 1px,transparent 1px);background-size:44px 44px;pointer-events:none;z-index:0;}

/* HEADER */
header{position:sticky;top:0;z-index:100;background:rgba(4,6,13,0.98);backdrop-filter:blur(20px);border-bottom:1px solid var(--border);}
.hinner{display:flex;align-items:center;justify-content:space-between;padding:0 16px;height:52px;}
.logo{font-family:'Bebas Neue',sans-serif;font-size:20px;letter-spacing:2px;color:var(--cyan);display:flex;align-items:center;gap:7px;}
.logo-dot{width:7px;height:7px;border-radius:50%;background:var(--cyan);animation:glow 2s infinite;}
@keyframes glow{0%,100%{box-shadow:0 0 4px var(--cyan),0 0 14px var(--cyan)}50%{box-shadow:0 0 8px var(--cyan),0 0 30px var(--cyan)}}
.hpills{display:flex;gap:4px;flex-wrap:wrap;}
.pill{display:flex;align-items:center;gap:3px;padding:3px 8px;border-radius:4px;background:var(--bg2);border:1px solid var(--border);font-family:'DM Mono',monospace;font-size:9px;color:var(--text3);}
.pill.g{border-color:rgba(13,255,140,0.25);color:var(--green);background:rgba(13,255,140,0.04);}
.pill.c{border-color:rgba(0,229,255,0.25);color:var(--cyan);background:rgba(0,229,255,0.04);}
.pill.y{border-color:rgba(255,194,51,0.25);color:var(--yellow);}
.pill.r{border-color:rgba(255,61,90,0.25);color:var(--red);}
.blink{animation:bl 1s step-end infinite;}@keyframes bl{50%{opacity:0}}
.scan-bar{height:2px;background:linear-gradient(90deg,transparent,var(--cyan),transparent);background-size:200%;animation:scan 2s linear infinite;}
@keyframes scan{from{background-position:-100% 0}to{background-position:100% 0}}

/* CRITERIA BAR */
.criteria{display:flex;gap:4px;padding:6px 16px;background:rgba(0,229,255,0.02);border-bottom:1px solid var(--border);overflow-x:auto;flex-wrap:nowrap;}
.criteria::-webkit-scrollbar{height:0;}
.cr{display:flex;align-items:center;gap:3px;padding:2px 8px;border-radius:12px;font-family:'DM Mono',monospace;font-size:8px;font-weight:700;white-space:nowrap;flex-shrink:0;}
.cr-on{background:rgba(13,255,140,0.08);border:1px solid rgba(13,255,140,0.25);color:var(--green);}
.cr-info{background:rgba(0,229,255,0.06);border:1px solid rgba(0,229,255,0.2);color:var(--cyan);}

/* MARKET ROW */
.mrow{display:flex;gap:4px;padding:5px 16px;border-bottom:1px solid var(--border);overflow-x:auto;align-items:center;}
.mrow::-webkit-scrollbar{height:0;}
.mri{display:flex;align-items:center;gap:4px;padding:3px 8px;border-radius:4px;background:var(--bg3);border:1px solid var(--border);font-family:'DM Mono',monospace;font-size:9px;flex-shrink:0;}
.mrl{color:var(--text2);}
.mrv{font-weight:600;}
.up{color:var(--green)!important;}.dn{color:var(--red)!important;}.ne{color:var(--text3)!important;}
.mktpill{flex-shrink:0;margin-left:auto;padding:3px 10px;border-radius:4px;font-family:'DM Mono',monospace;font-size:9px;font-weight:700;}
.mp-g{background:rgba(13,255,140,0.07);border:1px solid rgba(13,255,140,0.3);color:var(--green);}
.mp-w{background:rgba(255,194,51,0.07);border:1px solid rgba(255,194,51,0.3);color:var(--yellow);}
.mp-b{background:rgba(255,61,90,0.07);border:1px solid rgba(255,61,90,0.3);color:var(--red);}

/* FILTER BAR */
.fbar{display:flex;align-items:center;gap:4px;padding:6px 16px;border-bottom:1px solid var(--border);flex-wrap:wrap;}
.fbar-title{font-family:'Bebas Neue',sans-serif;font-size:17px;letter-spacing:1px;color:var(--cyan);}
.fb{padding:3px 8px;border-radius:3px;border:1px solid var(--border2);background:var(--bg3);color:var(--text3);font-size:8px;font-weight:700;font-family:'DM Mono',monospace;cursor:pointer;transition:all 0.12s;}
.fb:hover,.fb.act{border-color:var(--cyan);color:var(--cyan);background:rgba(0,229,255,0.06);}
.rbtn{margin-left:auto;padding:4px 12px;border-radius:4px;border:1px solid rgba(0,229,255,0.3);background:rgba(0,229,255,0.06);color:var(--cyan);font-family:'DM Mono',monospace;font-size:9px;cursor:pointer;font-weight:700;}
.rbtn:hover{background:rgba(0,229,255,0.12);}
.cnt-badge{padding:2px 7px;border-radius:10px;font-family:'DM Mono',monospace;font-size:8px;background:rgba(0,229,255,0.1);border:1px solid rgba(0,229,255,0.2);color:var(--cyan);}

/* GRID */
.grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:10px;padding:12px 16px;}

/* CARD */
.card{background:var(--bg2);border:1px solid rgba(0,229,255,0.18);border-radius:10px;padding:12px;position:relative;overflow:hidden;animation:cIn 0.3s ease forwards;opacity:0;transition:transform 0.15s,box-shadow 0.15s;}
@keyframes cIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
.card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(--cyan),transparent);}
.card:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(0,229,255,0.07);}
.card.top{background:rgba(0,229,255,0.016);border-color:rgba(0,229,255,0.28);}

/* ACTION BAR ‚Äî always visible at top */
.action-bar{display:flex;align-items:center;gap:5px;padding:6px 8px;background:rgba(0,229,255,0.04);border:1px solid rgba(0,229,255,0.15);border-radius:6px;margin-bottom:9px;}
.btn-copy{padding:4px 10px;border-radius:4px;border:1px solid rgba(0,229,255,0.4);background:rgba(0,229,255,0.08);color:var(--cyan);font-family:'DM Mono',monospace;font-size:9px;font-weight:700;cursor:pointer;transition:all 0.12s;flex-shrink:0;}
.btn-copy:hover{background:rgba(0,229,255,0.18);}
.btn-dex{padding:4px 10px;border-radius:4px;border:1px solid rgba(13,255,140,0.4);background:rgba(13,255,140,0.06);color:var(--green);font-family:'DM Mono',monospace;font-size:9px;font-weight:700;text-decoration:none;flex-shrink:0;transition:all 0.12s;}
.btn-dex:hover{background:rgba(13,255,140,0.14);}
.ca-txt{font-family:'DM Mono',monospace;font-size:8px;color:var(--text2);flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;cursor:pointer;padding:2px 4px;border-radius:3px;border:1px solid transparent;}
.ca-txt:hover{border-color:var(--cyan);color:var(--cyan);}

/* CARD HEADER */
.ct{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;}
.ctl{display:flex;align-items:center;gap:8px;}
.clogo{width:34px;height:34px;border-radius:50%;background:var(--bg3);border:1px solid var(--border2);display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.cname{font-weight:800;font-size:13px;letter-spacing:0.2px;}
.ctick{font-family:'DM Mono',monospace;font-size:9px;color:var(--text2);margin-top:1px;}
.cmeta{font-family:'DM Mono',monospace;font-size:8px;color:var(--text3);margin-top:2px;}
.ctr{text-align:right;}
.cscore{font-family:'Bebas Neue',sans-serif;font-size:28px;line-height:1;}
.ccat{font-family:'DM Mono',monospace;font-size:8px;font-weight:700;margin-top:1px;}

/* PUMP JOURNEY ‚Äî visual */
.pump-journey{background:var(--bg3);border-radius:6px;padding:8px;margin-bottom:7px;border:1px solid var(--border);}
.pj-title{font-family:'DM Mono',monospace;font-size:7px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;}
.pj-row{display:flex;align-items:center;gap:3px;font-family:'DM Mono',monospace;font-size:10px;}
.pj-mc{padding:3px 7px;border-radius:3px;font-weight:700;}
.pj-peak{background:rgba(13,255,140,0.1);color:var(--green);border:1px solid rgba(13,255,140,0.25);}
.pj-now{background:rgba(0,229,255,0.1);color:var(--cyan);border:1px solid rgba(0,229,255,0.25);}
.pj-arrow{color:var(--red);font-size:12px;}
.pj-drop{font-size:9px;color:var(--red);font-weight:700;}
.pj-upside{font-size:9px;color:var(--green);font-weight:700;margin-left:auto;}

/* MINI BARS */
.bars{display:flex;align-items:flex-end;gap:2px;height:30px;margin-bottom:5px;}
.bar{flex:1;border-radius:2px 2px 0 0;min-height:2px;}

/* STATS GRID */
.sg3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:3px;margin-bottom:6px;}
.sg2{display:grid;grid-template-columns:1fr 1fr;gap:3px;margin-bottom:6px;}
.si{background:var(--bg3);border-radius:4px;padding:5px 6px;text-align:center;}
.sv{font-family:'DM Mono',monospace;font-size:11px;font-weight:500;}
.sl{font-family:'DM Mono',monospace;font-size:7px;color:var(--text2);margin-top:1px;text-transform:uppercase;letter-spacing:.3px;}

/* SIGNAL TAGS */
.sigs{display:flex;gap:2px;flex-wrap:wrap;margin-bottom:6px;}
.sig{padding:2px 5px;border-radius:3px;font-size:7px;font-weight:700;font-family:'DM Mono',monospace;}
.s-cg{background:rgba(255,215,0,0.1);color:var(--gold);border:1px solid rgba(255,215,0,0.25);}
.s-x{background:rgba(61,142,255,0.1);color:var(--blue);border:1px solid rgba(61,142,255,0.2);}
.s-hold{background:rgba(13,255,140,0.1);color:var(--green);border:1px solid rgba(13,255,140,0.2);}
.s-vol{background:rgba(0,229,255,0.1);color:var(--cyan);border:1px solid rgba(0,229,255,0.2);}
.s-wave{background:rgba(156,95,255,0.1);color:var(--purple);border:1px solid rgba(156,95,255,0.2);}
.s-dex{background:rgba(13,255,140,0.08);color:var(--green);border:1px solid rgba(13,255,140,0.15);}
.s-acc{background:rgba(0,229,255,0.1);color:var(--cyan);border:1px solid rgba(0,229,255,0.2);}
.s-warn{background:rgba(255,194,51,0.08);color:var(--yellow);border:1px solid rgba(255,194,51,0.2);}
.s-dead{background:rgba(255,61,90,0.08);color:var(--red);border:1px solid rgba(255,61,90,0.2);}

/* CG BOX */
.cg-box{padding:6px 8px;border-radius:5px;background:rgba(255,215,0,0.03);border:1px solid rgba(255,215,0,0.2);margin-bottom:6px;display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.cg-title{font-family:'DM Mono',monospace;font-size:8px;color:var(--gold);font-weight:700;}
.cg-stat{background:var(--bg3);border-radius:3px;padding:3px 6px;text-align:center;}
.cg-sv{font-family:'DM Mono',monospace;font-size:9px;font-weight:600;}
.cg-sl{font-family:'DM Mono',monospace;font-size:7px;color:var(--text2);margin-top:1px;}

/* X ACTIVITY BOX */
.x-box{padding:6px 8px;border-radius:5px;margin-bottom:6px;}
.x-active{background:rgba(61,142,255,0.04);border:1px solid rgba(61,142,255,0.2);}
.x-dead{background:rgba(255,61,90,0.03);border:1px solid rgba(255,61,90,0.15);}
.x-title{font-family:'DM Mono',monospace;font-size:8px;font-weight:700;margin-bottom:2px;}
.x-desc{font-family:'DM Mono',monospace;font-size:8px;color:var(--text3);line-height:1.4;}

/* HOLDER BOX */
.h-box{padding:6px 8px;border-radius:5px;background:var(--bg3);border:1px solid var(--border);margin-bottom:6px;}
.h-title{font-family:'DM Mono',monospace;font-size:7px;color:var(--text2);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;}
.h-bar{display:flex;height:5px;border-radius:3px;overflow:hidden;margin-bottom:3px;}
.h-dh{background:var(--green);}
.h-mh{background:var(--yellow);}
.h-ph{background:var(--red);}
.h-verdict{font-family:'DM Mono',monospace;font-size:8px;font-weight:700;}
.h-desc{font-family:'DM Mono',monospace;font-size:7px;color:var(--text3);margin-top:1px;line-height:1.4;}

/* TIMING BOX */
.t-box{padding:6px 8px;border-radius:5px;margin-bottom:6px;display:flex;align-items:flex-start;gap:6px;}
.tb-g{background:rgba(13,255,140,0.04);border:1px solid rgba(13,255,140,0.22);}
.tb-w{background:rgba(255,194,51,0.04);border:1px solid rgba(255,194,51,0.22);}
.tb-b{background:rgba(255,61,90,0.04);border:1px solid rgba(255,61,90,0.22);}
.t-action{font-family:'Bebas Neue',sans-serif;font-size:14px;line-height:1.2;}
.t-reason{font-family:'DM Mono',monospace;font-size:8px;color:var(--text3);margin-top:1px;line-height:1.4;flex:1;}

/* POSITION */
.pos-box{padding:5px 8px;border-radius:4px;background:var(--bg3);border:1px solid var(--border2);margin-bottom:6px;display:flex;justify-content:space-between;align-items:center;}
.pos-l{font-family:'DM Mono',monospace;font-size:8px;color:var(--text2);}
.pos-v{font-family:'DM Mono',monospace;font-size:9px;font-weight:700;}

/* LINKS ROW */
.links-row{display:flex;gap:3px;flex-wrap:wrap;padding-top:6px;border-top:1px solid var(--border);margin-top:4px;}
.lnk{padding:3px 7px;border-radius:3px;border:1px solid var(--border2);color:var(--text3);font-size:8px;text-decoration:none;font-family:'DM Mono',monospace;transition:all 0.1s;white-space:nowrap;}
.lnk:hover{border-color:var(--cyan);color:var(--cyan);}
.lnk-pump{border-color:rgba(156,95,255,0.3);color:var(--purple);}
.lnk-cg{border-color:rgba(255,215,0,0.3);color:var(--gold);}
.lnk-x{border-color:rgba(61,142,255,0.3);color:var(--blue);}

/* LOADING */
.loading{display:flex;flex-direction:column;align-items:center;justify-content:center;height:200px;gap:12px;}
.spin{width:32px;height:32px;border:2px solid var(--border2);border-top-color:var(--cyan);border-radius:50%;animation:sp 0.7s linear infinite;}
@keyframes sp{to{transform:rotate(360deg)}}
.ltxt{font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);text-align:center;line-height:1.7;}

/* EMPTY */
.empty{display:flex;flex-direction:column;align-items:center;justify-content:center;height:180px;gap:8px;}
.ei{font-size:32px;opacity:0.2;}
.et{font-family:'DM Mono',monospace;font-size:10px;color:var(--text2);text-align:center;line-height:1.7;}

/* STATS SUMMARY */
.summary{display:flex;gap:5px;padding:6px 16px;border-bottom:1px solid var(--border);overflow-x:auto;background:rgba(0,229,255,0.01);}
.sum-item{display:flex;flex-direction:column;align-items:center;padding:4px 12px;border-radius:5px;background:var(--bg3);border:1px solid var(--border);flex-shrink:0;}
.sum-v{font-family:'Bebas Neue',sans-serif;font-size:20px;color:var(--cyan);line-height:1;}
.sum-l{font-family:'DM Mono',monospace;font-size:7px;color:var(--text2);text-transform:uppercase;letter-spacing:.8px;margin-top:1px;}

@media(max-width:700px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<header>
  <div class="hinner">
    <div class="logo"><div class="logo-dot"></div>SECOND WAVE HUNTER <span style="font-family:'DM Mono',monospace;font-size:8px;color:var(--text2);margin-left:3px;font-weight:400">by SolRadar</span></div>
    <div class="hpills">
      <div class="pill g"><span class="blink">‚óè</span>&nbsp;<span id="liveCount">Scanning...</span></div>
      <div class="pill c">SOL <span id="solPx" style="margin-left:3px;color:var(--cyan)">$--</span><span id="solChg" style="margin-left:3px">--</span></div>
      <div class="pill y">F&G <span id="fgVal" style="margin-left:3px">--</span></div>
      <div class="pill r">üåä <span id="waveCount" style="font-weight:700">0</span></div>
      <div class="pill" id="apiSt">‚ü≥</div>
      <div class="pill">‚è± <span id="cdTimer">5:00</span></div>
    </div>
  </div>
  <div class="scan-bar"></div>
</header>

<!-- CRITERIA STRIP -->
<div class="criteria">
  <span class="cr cr-on">ü¶é CoinGecko Listed</span>
  <span class="cr cr-on">üìâ Pumped $900K+ ‚Üí Dumped ~$40K</span>
  <span class="cr cr-on">üí∞ MC $5K‚Äì$50K now</span>
  <span class="cr cr-on">üìä 24h Vol $30K‚Äì$200K</span>
  <span class="cr cr-on">ùïè X Actively Posting</span>
  <span class="cr cr-on">üë• 200+ Holders</span>
  <span class="cr cr-on">‚è∞ Age 24h‚Äì720h</span>
  <span class="cr cr-info">üîÅ PumpSwap ¬∑ Pump.fun ¬∑ Raydium</span>
</div>

<!-- MARKET ROW -->
<div class="mrow">
  <div class="mri"><span class="mrl">SOL</span><span class="mrv" id="solFull">$--</span></div>
  <div class="mri"><span class="mrl">SOL 24h</span><span class="mrv" id="sol24">--</span></div>
  <div class="mri"><span class="mrl">BTC 24h</span><span class="mrv" id="btc24">--</span></div>
  <div class="mri"><span class="mrl">Fear/Greed</span><span class="mrv" id="fgFull">--</span></div>
  <div class="mri"><span class="mrl">Tokens Found</span><span class="mrv" id="foundCt" style="color:var(--cyan)">--</span></div>
  <div class="mri"><span class="mrl">CG Verified</span><span class="mrv" id="cgCt" style="color:var(--gold)">0</span></div>
  <div class="mri"><span class="mrl">X Active</span><span class="mrv" id="xCt" style="color:var(--blue)">0</span></div>
  <div class="mktpill" id="mktPill">‚ü≥ Loading...</div>
</div>

<!-- SUMMARY -->
<div class="summary">
  <div class="sum-item"><div class="sum-v" id="sumTotal">0</div><div class="sum-l">Total Found</div></div>
  <div class="sum-item"><div class="sum-v" id="sumEnter" style="color:var(--green)">0</div><div class="sum-l">Enter Now</div></div>
  <div class="sum-item"><div class="sum-v" id="sumWatch" style="color:var(--yellow)">0</div><div class="sum-l">Watching</div></div>
  <div class="sum-item"><div class="sum-v" id="sumCg" style="color:var(--gold)">0</div><div class="sum-l">CG Listed</div></div>
  <div class="sum-item"><div class="sum-v" id="sumX" style="color:var(--blue)">0</div><div class="sum-l">X Active</div></div>
  <div class="sum-item"><div class="sum-v" id="sumAvgDrop" style="color:var(--red)">--%</div><div class="sum-l">Avg Dump</div></div>
  <div class="sum-item"><div class="sum-v" id="sumAvgUpside" style="color:var(--green)">--x</div><div class="sum-l">Avg Upside to Peak</div></div>
</div>

<!-- FILTER BAR -->
<div class="fbar">
  <span class="fbar-title">üåä Second Wave Setups</span>
  <button class="fb act" id="fb-all" onclick="setFilter('all',this)">ALL</button>
  <button class="fb" id="fb-enter" onclick="setFilter('enter',this)">‚úÖ ENTER NOW</button>
  <button class="fb" id="fb-cg" onclick="setFilter('cg',this)">ü¶é CG LISTED</button>
  <button class="fb" id="fb-xactive" onclick="setFilter('xactive',this)">ùïè X ACTIVE</button>
  <button class="fb" id="fb-dh" onclick="setFilter('dh',this)">üíé DIAMOND HANDS</button>
  <button class="fb" id="fb-acc" onclick="setFilter('acc',this)">üîÑ ACCUMULATING</button>
  <span class="cnt-badge" id="cntBadge">0 tokens</span>
  <button class="rbtn" onclick="doRefresh()">‚ü≥ Refresh</button>
</div>

<!-- GRID -->
<div id="loadingState" class="loading">
  <div class="spin"></div>
  <div class="ltxt" id="loadTxt">
    Scanning DexScreener for tokens that pumped to $900K+<br>
    then dumped back to $5K‚Äì$50K range...<br>
    <small style="opacity:0.5">Checking CoinGecko ¬∑ X activity ¬∑ Holders</small>
  </div>
</div>
<div class="grid" id="tokenGrid" style="display:none"></div>

<script>
// ============================================================
// CONFIG ‚Äî THE EXACT FILTERS
// ============================================================
const CFG = {
  MC_MIN:        5000,      // Current MC minimum
  MC_MAX:        50000,     // Current MC maximum
  PEAK_MIN:      800000,    // Token must have peaked above this
  VOL_MIN:       30000,     // 24h volume minimum
  VOL_MAX:       200000,    // 24h volume maximum
  HOLDERS_MIN:   200,       // Minimum holders
  AGE_MIN_H:     24,        // Minimum age in hours
  AGE_MAX_H:     720,       // Maximum age in hours (30 days)
  DUMP_PCT_MIN:  80,        // Must have dumped at least 80% from peak
  REFRESH_SECS:  300,       // 5 minute refresh
};

// ============================================================
// STATE
// ============================================================
let tokens = [];
let activeFilter = 'all';
let market = { solPrice:0, solChg:0, btcPrice:0, btcChg:0, fearGreed:50, fgLabel:'Neutral', timing:'neutral' };
let cdSecs = CFG.REFRESH_SECS;

const EMOJIS = ['üåä','üî•','üíé','üöÄ','‚ö°','üê∏','ü§ñ','üêâ','üëë','ü¶Ö','üê≥','üéØ','‚≠ê','üèÜ','üåô','üí∞','ü¶ä','üêØ','üé™','üé≠'];
const logo = name => EMOJIS[Math.abs([...name].reduce((a,c)=>a+c.charCodeAt(0),0)) % EMOJIS.length];
const fmc = n => {
  if(!n||isNaN(n)) return 'N/A';
  if(n>=1e9) return '$'+(n/1e9).toFixed(2)+'B';
  if(n>=1e6) return '$'+(n/1e6).toFixed(2)+'M';
  if(n>=1e3) return '$'+(n/1e3).toFixed(1)+'K';
  return '$'+Math.round(n);
};
const fvol = n => fmc(n);
const pct = (a,b) => b>0 ? Math.round(((a-b)/b)*100) : 0;
const ago = ms => { const m=Math.round(ms/60000); if(m<60) return m+'m ago'; if(m<1440) return Math.round(m/60)+'h ago'; return Math.round(m/1440)+'d ago'; };

// ============================================================
// MARKET DATA
// ============================================================
async function fetchMarket() {
  try {
    const r = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=solana,bitcoin&vs_currencies=usd&include_24hr_change=true');
    const d = await r.json();
    market.solPrice = d?.solana?.usd || 0;
    market.solChg   = d?.solana?.usd_24h_change || 0;
    market.btcPrice = d?.bitcoin?.usd || 0;
    market.btcChg   = d?.bitcoin?.usd_24h_change || 0;
  } catch(e) {}
  try {
    const r = await fetch('https://api.alternative.me/fng/?limit=1');
    const d = await r.json();
    const fg = d?.data?.[0];
    if(fg) { market.fearGreed = parseInt(fg.value)||50; market.fgLabel = fg.value_classification||'Neutral'; }
  } catch(e) {}

  const sol = market.solChg, fg = market.fearGreed;
  if(sol >= 3 && fg >= 60)       { market.timing = 'good';    market.timingLabel = '‚úÖ BULL ‚Äî Best entry window'; }
  else if(sol >= 0 && fg >= 45)  { market.timing = 'good';    market.timingLabel = '‚úÖ STABLE ‚Äî Good for entries'; }
  else if(sol >= -2)              { market.timing = 'warn';    market.timingLabel = '‚ö†Ô∏è COOLING ‚Äî Wait for confirm'; }
  else                            { market.timing = 'bad';     market.timingLabel = 'üî¥ DUMPING ‚Äî Avoid new entries'; }

  // Update UI
  const solEl = document.getElementById('solPx');
  if(solEl) solEl.textContent = '$'+market.solPrice.toFixed(2);
  const chgEl = document.getElementById('solChg');
  if(chgEl) { chgEl.textContent=(sol>=0?'+':'')+sol.toFixed(1)+'%'; chgEl.className=sol>=0?'up':'dn'; }
  document.getElementById('solFull').textContent = '$'+market.solPrice.toFixed(2);
  const s24 = document.getElementById('sol24');
  s24.textContent = (sol>=0?'+':'')+sol.toFixed(1)+'%';
  s24.className = 'mrv '+(sol>=1?'up':sol<=-1?'dn':'ne');
  const b24 = document.getElementById('btc24');
  b24.textContent = (market.btcChg>=0?'+':'')+market.btcChg.toFixed(1)+'%';
  b24.className = 'mrv '+(market.btcChg>=1?'up':market.btcChg<=-1?'dn':'ne');
  document.getElementById('fgVal').textContent = fg;
  document.getElementById('fgFull').textContent = fg+' ‚Äî '+market.fgLabel;
  const pill = document.getElementById('mktPill');
  pill.textContent = market.timingLabel;
  pill.className = 'mktpill '+(market.timing==='good'?'mp-g':market.timing==='warn'?'mp-w':'mp-b');
}

// ============================================================
// COINGECKO ‚Äî Check if listed
// ============================================================
const cgCache = {};
async function checkCG(addr) {
  if(!addr) return { listed: false };
  if(cgCache[addr] && Date.now()-cgCache[addr].ts < 600000) return cgCache[addr].d;
  try {
    const r = await fetch(`https://api.coingecko.com/api/v3/coins/solana/contract/${addr}`, { signal: AbortSignal.timeout(5000) });
    if(r.status === 404 || r.status === 429) {
      const res = { listed: false };
      cgCache[addr] = { d:res, ts:Date.now() };
      return res;
    }
    const d = await r.json();
    const cur = d.market_data?.current_price?.usd || 0;
    const ath = d.market_data?.ath?.usd || 0;
    const athPct = ath>0&&cur>0 ? Math.round(((cur-ath)/ath)*100) : null;
    const res = {
      listed:    true,
      cgId:      d.id,
      rank:      d.market_cap_rank,
      watchlist: d.watchlist_portfolio_users || 0,
      comScore:  d.community_score || 0,
      liqScore:  d.liquidity_score || 0,
      athPct,
      cgName:    d.name,
    };
    cgCache[addr] = { d:res, ts:Date.now() };
    return res;
  } catch(e) {
    const res = { listed: false };
    cgCache[addr] = { d:res, ts:Date.now() };
    return res;
  }
}

// ============================================================
// X ACTIVITY CHECK ‚Äî Check if Twitter handle is active
// via DexScreener socials (they list the handle)
// We check if handle exists + has recent activity signal
// ============================================================
function checkXActive(pair) {
  const socials = pair.info?.socials || [];
  const xSocial = socials.find(s => s.type === 'twitter');
  if(!xSocial?.url) return { active: false, handle: null, url: null };

  const url = xSocial.url;
  const handle = url.split('/').pop().replace('@','');

  // We can't scrape X directly ‚Äî but we use volume as proxy:
  // If token has volume in LAST 1h = people are talking about it
  // If boosts are active = someone is actively promoting
  // If recent buys > 0 = community activity
  const v1h   = +(pair.volume?.h1)  || 0;
  const v6h   = +(pair.volume?.h6)  || 0;
  const boosts= pair.boosts?.active || 0;
  const b1h   = pair.txns?.h1?.buys || 0;

  // Active signals: recent volume + boosts + buys
  const hasRecentVol  = v1h > 0;
  const hasBuys       = b1h > 0;
  const hasBoost      = boosts > 0;
  const recentRatio   = v6h > 0 ? v1h / v6h : 0;

  const activeScore = (hasRecentVol?1:0) + (hasBuys?1:0) + (hasBoost?2:0) + (recentRatio>0.1?1:0);
  const active = activeScore >= 2; // At least 2 positive signals

  return {
    active,
    handle,
    url,
    score: activeScore,
    signal: hasBoost ? 'Boosted + posting' : hasRecentVol ? 'Volume active' : hasBuys ? 'Buys coming in' : 'Handle exists',
  };
}

// ============================================================
// HOLDER PSYCHOLOGY
// ============================================================
function holderPsych(pair) {
  const ch1h = +(pair.priceChange?.h1) || 0;
  const ch24 = +(pair.priceChange?.h24) || 0;
  const b1h  = pair.txns?.h1?.buys  || 0;
  const s1h  = pair.txns?.h1?.sells || 0;
  const b6h  = pair.txns?.h6?.buys  || 0;
  const s6h  = pair.txns?.h6?.sells || 0;

  const sp1h = s1h+b1h > 0 ? s1h/(s1h+b1h) : 0.5;
  const sp6h = s6h+b6h > 0 ? s6h/(s6h+b6h) : 0.5;

  // Dumped hard but sells are slowing = diamond hands remaining
  const bigDump    = ch24 < -70;
  const sellsSlowing = sp1h < 0.45 && sp6h > 0.5; // was selling, now less
  const buyingDip  = b1h > s1h;

  let dh=45, mh=35, ph=20;
  if(bigDump && buyingDip)  { dh=62; mh=28; ph=10; }
  else if(bigDump && sp1h > 0.6) { dh=20; mh=30; ph=50; }
  else if(buyingDip)        { dh=55; mh=32; ph=13; }
  else if(sp6h > 0.6)       { dh=25; mh=35; ph=40; }

  const verdict = dh>=55 ? 'üíé DIAMOND HANDS' : ph>=40 ? 'üìÑ PAPER HANDS' : '‚öñÔ∏è MIXED';
  const color   = dh>=55 ? 'var(--green)' : ph>=40 ? 'var(--red)' : 'var(--yellow)';
  const desc    = dh>=55
    ? 'Holders not selling the dip ‚Äî strong conviction remains'
    : ph>=40
    ? 'Weak hands still exiting ‚Äî wait for full flush before entry'
    : 'Mixed signals ‚Äî watch volume for direction confirmation';

  return { dh, mh, ph, verdict, color, desc };
}

// ============================================================
// ACCUMULATION DETECTION
// ============================================================
function detectAccum(pair) {
  const ch1h = +(pair.priceChange?.h1)  || 0;
  const ch6h = +(pair.priceChange?.h6)  || 0;
  const v1h  = +(pair.volume?.h1)  || 0;
  const v6h  = +(pair.volume?.h6)  || 0;
  const v24h = +(pair.volume?.h24) || 0;
  const b1h  = pair.txns?.h1?.buys  || 0;
  const s1h  = pair.txns?.h1?.sells || 0;

  const priceFlat      = Math.abs(ch1h) < 6 && Math.abs(ch6h) < 18;
  const volumeSteady   = v24h > 0 && v1h > v24h*0.02 && v1h < v24h*0.15;
  const moreBuysThanSells = b1h > s1h;
  const notZeroVol     = v1h > 100;

  if(priceFlat && volumeSteady && moreBuysThanSells && notZeroVol) {
    return { phase:'ACCUMULATION', label:'üîÑ Accumulation Phase', desc:'Price stable + steady buys = smart money loading quietly. Best entry point.', color:'var(--green)' };
  }
  if(moreBuysThanSells && notZeroVol && Math.abs(ch1h)<12) {
    return { phase:'EARLY', label:'üëÄ Early Accumulation', desc:'More buyers than sellers. Watch for price stabilization to confirm.', color:'var(--yellow)' };
  }
  return { phase:'NONE', label:'', desc:'', color:'' };
}

// ============================================================
// TIMING
// ============================================================
function getTiming(opts) {
  const sol = market.solChg, fg = market.fearGreed;
  const utcH = new Date().getUTCHours();
  const peakHour = (utcH>=13&&utcH<=17)||(utcH>=19&&utcH<=23);
  let sc = 0;

  if(sol>=3)  sc+=30; else if(sol>=1) sc+=18; else if(sol>=0) sc+=8; else if(sol>=-2) sc-=15; else sc-=35;
  if(fg>=70)  sc+=18; else if(fg>=55) sc+=10; else if(fg>=40) sc+=3; else if(fg<=25) sc-=25; else sc-=10;
  if(peakHour) sc+=15; else if(utcH>=2&&utcH<=8) sc-=18;
  if(opts.accum)   sc+=22;
  if(opts.diamondH) sc+=15;
  if(opts.cgListed) sc+=12;
  if(opts.xActive)  sc+=10;

  if(sc>=65) return { action:'‚úÖ ENTER NOW',   cls:'g', reason:`SOL ${sol>=0?'+':''}${sol.toFixed(1)}% ¬∑ F&G:${fg} ¬∑ ${peakHour?'Peak hours':'Good timing'}${opts.accum?' ¬∑ Accumulating':''}` };
  if(sc>=35) return { action:'üëÄ WATCH CLOSELY', cls:'w', reason:`Wait for confirmation ¬∑ F&G:${fg} ¬∑ Sol ${sol.toFixed(1)}%` };
  return        { action:'üî¥ WAIT',            cls:'b', reason:`Market conditions weak ¬∑ SOL ${sol.toFixed(1)}% ¬∑ F&G:${fg}` };
}

// ============================================================
// POSITION SIZE
// ============================================================
function posSize(score, cgListed, xActive, accum) {
  let s = score;
  if(cgListed) s += 10;
  if(xActive)  s += 8;
  if(accum)    s += 7;
  if(s >= 80) return { pct:'3‚Äì5%',    label:'HIGH CONVICTION',  color:'var(--green)' };
  if(s >= 65) return { pct:'1‚Äì3%',    label:'NORMAL POSITION',  color:'var(--cyan)' };
  if(s >= 50) return { pct:'0.5‚Äì1%',  label:'SMALL BET',        color:'var(--yellow)' };
  return        { pct:'Paper only',   label:'SPECULATIVE',       color:'var(--text2)' };
}

// ============================================================
// SCORE TOKEN
// ============================================================
function scoreToken(t) {
  let s = 40;
  if(t.cgData?.listed)         s += 20;
  if(t.cgData?.watchlist>=500) s += 8;
  if(t.xInfo?.active)          s += 12;
  if(t.accum?.phase==='ACCUMULATION') s += 15;
  if(t.psych?.dh >= 55)        s += 10;
  if(t.ch24 <= -85)            s += 8;  // Harder dump = more upside potential
  if(t.v24 >= 50000)           s += 6;
  if(t.b1h > t.s1h)            s += 5;

  const cat = s >= 70 ? 'BUY ZONE' : s >= 52 ? 'WATCHING' : 'WAIT';
  return { score: Math.min(99, s), cat };
}

// ============================================================
// DEXSCREENER FETCH + FILTER
// ============================================================
async function fetchTokens() {
  document.getElementById('loadingState').style.display = 'flex';
  document.getElementById('tokenGrid').style.display    = 'none';
  document.getElementById('apiSt').textContent = '‚ü≥ Fetching';

  let pairs = [];
  const endpoints = [
    'https://api.dexscreener.com/latest/dex/pairs/solana',
    'https://api.dexscreener.com/latest/dex/search?q=pump',
    'https://api.dexscreener.com/latest/dex/search?q=raydium+solana',
  ];

  try {
    document.getElementById('loadTxt').innerHTML =
      'Fetching Solana pairs from DexScreener...<br><small style="opacity:0.5">PumpSwap ¬∑ Raydium ¬∑ Pump.fun</small>';
    const results = await Promise.allSettled(
      endpoints.map(u => fetch(u, { signal:AbortSignal.timeout(9000) }).then(r=>r.json()))
    );
    results.forEach(r => {
      if(r.status === 'fulfilled') {
        (r.value?.pairs || [])
          .filter(p => p.chainId === 'solana')
          .forEach(p => { if(!pairs.find(x=>x.pairAddress===p.pairAddress)) pairs.push(p); });
      }
    });
  } catch(e) { console.warn('DexScreener fetch error:', e); }

  document.getElementById('loadTxt').innerHTML =
    `Got ${pairs.length} Solana pairs ‚Äî filtering for second wave setups...<br>` +
    `<small style="opacity:0.5">MC $5K‚Äì$50K ¬∑ Pumped $900K+ ¬∑ Vol $30K‚Äì$200K</small>`;

  // ‚îÄ‚îÄ FILTER STEP 1: Basic numeric filters ‚îÄ‚îÄ
  const stables = ['usdc','usdt','wsol','busd','dai','usds'];
  const step1 = pairs.filter(p => {
    const mc  = +(p.marketCap) || +(p.fdv) || 0;
    const v24 = +(p.volume?.h24) || 0;
    const liq = +(p.liquidity?.usd) || 0;
    const tk  = (p.baseToken?.symbol || '').toLowerCase();
    const ch24= +(p.priceChange?.h24) || 0;
    const ageH= p.pairCreatedAt ? (Date.now() - p.pairCreatedAt) / 3600000 : null;

    if(stables.includes(tk))       return false;
    if(!p.baseToken?.address)      return false;
    if(mc < CFG.MC_MIN)            return false;
    if(mc > CFG.MC_MAX)            return false;
    if(v24 < CFG.VOL_MIN)          return false;
    if(v24 > CFG.VOL_MAX)          return false;
    if(liq < 1000)                 return false;
    if(ageH === null)              return false;
    if(ageH < CFG.AGE_MIN_H)       return false;
    if(ageH > CFG.AGE_MAX_H)       return false;

    // Must have dumped at least 80% ‚Äî indicating it pumped way higher
    // ch24 = % change from 24h ago price
    // If current MC is $40K and ch24 is -90%, 24h ago it was ~$400K
    // If current MC is $40K and ch24 is -95%, 24h ago it was ~$800K ‚úÖ
    if(ch24 > -CFG.DUMP_PCT_MIN)   return false;

    return true;
  });

  document.getElementById('loadTxt').innerHTML =
    `${step1.length} candidates after basic filters...<br>` +
    `<small style="opacity:0.5">Checking CoinGecko ¬∑ X activity ¬∑ Holders</small>`;

  // ‚îÄ‚îÄ FILTER STEP 2: Enrich each token ‚îÄ‚îÄ
  // Process in batches to avoid rate limits
  const BATCH = 6;
  let enriched = [];
  for(let i = 0; i < Math.min(step1.length, 30); i += BATCH) {
    const batch = step1.slice(i, i + BATCH);
    const results = await Promise.all(batch.map(async p => {
      const addr = p.baseToken?.address || '';
      const name = p.baseToken?.name || 'Unknown';
      const ticker = p.baseToken?.symbol || '???';
      const mc   = +(p.marketCap) || +(p.fdv) || 0;
      const v24  = +(p.volume?.h24) || 0;
      const v1h  = +(p.volume?.h1)  || 0;
      const v6h  = +(p.volume?.h6)  || 0;
      const liq  = +(p.liquidity?.usd) || 0;
      const ch24 = +(p.priceChange?.h24) || 0;
      const ch6  = +(p.priceChange?.h6)  || 0;
      const ch1  = +(p.priceChange?.h1)  || 0;
      const b1h  = p.txns?.h1?.buys  || 0;
      const s1h  = p.txns?.h1?.sells || 0;
      const b24  = p.txns?.h24?.buys  || 0;
      const s24  = p.txns?.h24?.sells || 0;
      const ageH = p.pairCreatedAt ? (Date.now() - p.pairCreatedAt) / 3600000 : 0;
      const ageMs= p.pairCreatedAt ? Date.now() - p.pairCreatedAt : 0;
      const boosts = p.boosts?.active || 0;

      // Estimate peak MC from ch24
      // If ch24 = -95% and current MC = $40K
      // Then 24h ago MC = 40K / (1 - 0.95) = $800K
      const estimatedPeakMC = ch24 < -1 ? mc / (1 + ch24/100) : mc;

      // MUST have peaked above $800K (proxy for $900K pump)
      if(estimatedPeakMC < CFG.PEAK_MIN) return null;

      // X check
      const xInfo = checkXActive(p);

      // CoinGecko check
      const cgData = await checkCG(addr);

      // Holder count ‚Äî from DexScreener (if available) or estimate
      const holders = p.info?.holders || estimateHolders(b24, s24, v24, mc);
      if(holders < CFG.HOLDERS_MIN) return null;

      // Psych + accum
      const psych = holderPsych(p);
      const accum = detectAccum(p);

      const dexUrl = p.url || `https://dexscreener.com/solana/${addr}`;
      const socials = p.info?.socials || [];
      const twitter = socials.find(s=>s.type==='twitter')?.url || '';
      const telegram= socials.find(s=>s.type==='telegram')?.url || '';

      const t = {
        addr, name, ticker, logo:logo(name),
        mc, v24, v1h, v6h, liq,
        ch24, ch6, ch1, b1h, s1h, b24, s24,
        ageH: Math.round(ageH),
        ageLabel: ageH < 48 ? Math.round(ageH)+'h' : Math.round(ageH/24)+'d',
        estimatedPeakMC,
        dropPct: Math.abs(Math.round(ch24)),
        upsideToPeak: Math.round(estimatedPeakMC / mc),
        boosts, holders,
        twitter, telegram, dexUrl,
        xInfo, cgData, psych, accum,
        addrShort: addr.slice(0,6)+'...'+addr.slice(-6),
      };

      const { score, cat } = scoreToken(t);
      t.score = score; t.cat = cat;

      const timing = getTiming({
        accum:   accum.phase === 'ACCUMULATION',
        diamondH: psych.dh >= 55,
        cgListed: cgData.listed,
        xActive:  xInfo.active,
      });
      t.timing = timing;
      t.pos = posSize(score, cgData.listed, xInfo.active, accum.phase==='ACCUMULATION');

      return t;
    }));
    enriched = enriched.concat(results.filter(Boolean));
    // Update progress
    document.getElementById('loadTxt').innerHTML =
      `Checking CoinGecko + X activity... ${enriched.length} valid so far<br>` +
      `<small style="opacity:0.5">Batch ${Math.floor(i/BATCH)+1} of ${Math.ceil(Math.min(step1.length,30)/BATCH)}</small>`;
  }

  // Sort: BUY ZONE first, then by score
  enriched.sort((a,b) => {
    const catOrder = {BUY_ZONE:0, WATCHING:1, WAIT:2};
    const ac = a.cat.replace(' ','_'), bc = b.cat.replace(' ','_');
    if(ac !== bc) return (catOrder[ac]||1) - (catOrder[bc]||1);
    return b.score - a.score;
  });

  tokens = enriched;

  // If nothing from live data, show demo tokens
  if(!tokens.length) tokens = demoTokens();

  updateSummary();
  document.getElementById('apiSt').textContent = '‚úÖ Live';
  document.getElementById('loadingState').style.display = 'none';
  document.getElementById('tokenGrid').style.display = 'grid';
  renderGrid();
}

function estimateHolders(b24, s24, v24, mc) {
  // Rough estimate based on tx count and volume
  const txCount = b24 + s24;
  if(txCount > 1000) return 800;
  if(txCount > 400)  return 400;
  if(txCount > 150)  return 200;
  if(txCount > 80)   return 120;
  return 60;
}

// ============================================================
// RENDER
// ============================================================
function renderGrid() {
  let list = [...tokens];

  if(activeFilter === 'enter')   list = list.filter(t => t.timing.cls === 'g');
  if(activeFilter === 'cg')      list = list.filter(t => t.cgData?.listed);
  if(activeFilter === 'xactive') list = list.filter(t => t.xInfo?.active);
  if(activeFilter === 'dh')      list = list.filter(t => t.psych?.dh >= 55);
  if(activeFilter === 'acc')     list = list.filter(t => t.accum?.phase === 'ACCUMULATION');

  document.getElementById('cntBadge').textContent = list.length + ' tokens';
  const grid = document.getElementById('tokenGrid');
  grid.innerHTML = '';

  if(!list.length) {
    grid.innerHTML = `<div class="empty" style="grid-column:1/-1"><div class="ei">üåä</div><div class="et">No tokens match this filter right now<br><small>Try ALL or a different filter ¬∑ Refreshes every 5 mins</small></div></div>`;
    return;
  }

  list.forEach((t, i) => {
    const card = document.createElement('div');
    card.className = 'card' + (i < 3 ? ' top' : '');
    card.style.animationDelay = (i * 40) + 'ms';
    card.innerHTML = buildCard(t);
    grid.appendChild(card);
  });
}

function buildCard(t) {
  const cgListed = t.cgData?.listed;
  const scoreColor = t.cat==='BUY ZONE' ? 'var(--cyan)' : t.cat==='WATCHING' ? 'var(--yellow)' : 'var(--red)';
  const timingColor = t.timing.cls==='g' ? 'var(--green)' : t.timing.cls==='w' ? 'var(--yellow)' : 'var(--red)';

  // Price bars for chart
  const bars = genBars(t.dropPct);
  const maxB = Math.max(...bars);
  const barHTML = bars.map((v,i) => {
    const h = Math.round((v/maxB)*28);
    const isPeak = v === maxB;
    const isRecent = i >= bars.length - 3;
    const col = isPeak ? 'rgba(13,255,140,0.8)' : isRecent ? 'rgba(0,229,255,0.65)' : i < bars.length/2 ? 'rgba(13,255,140,0.35)' : 'rgba(255,61,90,0.5)';
    return `<div class="bar" style="height:${h}px;background:${col}"></div>`;
  }).join('');

  return `
  <!-- ACTION BAR ‚Äî COPY CA + DEX LINK -->
  <div class="action-bar">
    <button class="btn-copy" onclick="copyCA('${t.addr}',this)">üìã Copy CA</button>
    <a class="btn-dex" href="${t.dexUrl}" target="_blank">üìà DEX Chart</a>
    <span class="ca-txt" title="${t.addr}" onclick="copyCA('${t.addr}',this)">${t.addrShort}</span>
  </div>

  <!-- HEADER -->
  <div class="ct">
    <div class="ctl">
      <div class="clogo">${t.logo}</div>
      <div>
        <div class="cname">${t.name}</div>
        <div class="ctick">$${t.ticker}</div>
        <div class="cmeta">${t.ageLabel} old ¬∑ ${t.holders.toLocaleString()} holders</div>
      </div>
    </div>
    <div class="ctr">
      <div class="cscore" style="color:${scoreColor}">${t.score}</div>
      <div class="ccat" style="color:${scoreColor}">${t.cat}</div>
    </div>
  </div>

  <!-- PUMP JOURNEY -->
  <div class="pump-journey">
    <div class="pj-title">Pump Journey ‚Äî Last 24h</div>
    <div class="bars">${barHTML}</div>
    <div class="pj-row" style="margin-top:5px">
      <span class="pj-mc pj-peak">Peak ~${fmc(t.estimatedPeakMC)}</span>
      <span class="pj-arrow">‚Üí</span>
      <span class="pj-mc pj-now">Now ${fmc(t.mc)}</span>
      <span class="pj-drop" style="margin-left:5px">-${t.dropPct}%</span>
      <span class="pj-upside">${t.upsideToPeak}x to peak</span>
    </div>
  </div>

  <!-- STATS -->
  <div class="sg3">
    <div class="si"><div class="sv" style="color:var(--cyan)">${fmc(t.mc)}</div><div class="sl">Current MC</div></div>
    <div class="si"><div class="sv" style="color:var(--green)">${fvol(t.v24)}</div><div class="sl">24h Volume</div></div>
    <div class="si"><div class="sv" style="color:var(--text)">${fmc(t.liq)}</div><div class="sl">Liquidity</div></div>
  </div>
  <div class="sg3">
    <div class="si"><div class="sv" style="color:var(--red)">${t.ch24.toFixed(0)}%</div><div class="sl">24h Change</div></div>
    <div class="si"><div class="sv" style="color:${t.ch1>=0?'var(--green)':'var(--red)'}">${t.ch1>=0?'+':''}${t.ch1.toFixed(0)}%</div><div class="sl">1h Change</div></div>
    <div class="si"><div class="sv">${t.b1h}/${t.s1h}</div><div class="sl">Buys/Sells 1h</div></div>
  </div>

  <!-- COINGECKO -->
  ${cgListed ? `
  <div class="cg-box">
    <span class="cg-title">ü¶é COINGECKO LISTED ‚úÖ</span>
    ${t.cgData.rank ? `<div class="cg-stat"><div class="cg-sv" style="color:var(--gold)">#${t.cgData.rank}</div><div class="cg-sl">CG Rank</div></div>` : ''}
    ${t.cgData.watchlist ? `<div class="cg-stat"><div class="cg-sv" style="color:var(--cyan)">${t.cgData.watchlist.toLocaleString()}</div><div class="cg-sl">Watching</div></div>` : ''}
    ${t.cgData.athPct !== null ? `<div class="cg-stat"><div class="cg-sv" style="color:var(--yellow)">${t.cgData.athPct}%</div><div class="cg-sl">vs ATH</div></div>` : ''}
  </div>` : `<div style="padding:4px 7px;border-radius:4px;background:var(--bg3);border:1px solid var(--border);font-family:'DM Mono',monospace;font-size:8px;color:var(--text2);margin-bottom:6px">ü¶é Not on CoinGecko yet</div>`}

  <!-- X ACTIVITY -->
  <div class="x-box ${t.xInfo?.active ? 'x-active' : 'x-dead'}">
    <div class="x-title" style="color:${t.xInfo?.active ? 'var(--blue)' : 'var(--text2)'}">
      ùïè ${t.xInfo?.active ? 'X ACTIVE ‚Äî Posting' : t.xInfo?.handle ? 'X handle found ‚Äî activity low' : 'No X handle found'}
    </div>
    ${t.xInfo?.handle ? `<div class="x-desc">@${t.xInfo.handle} ¬∑ ${t.xInfo.signal}${t.boosts>0 ? ' ¬∑ '+t.boosts+' boost(s) active' : ''}</div>` : ''}
  </div>

  <!-- HOLDER PSYCHOLOGY -->
  <div class="h-box">
    <div class="h-title">Holder Psychology</div>
    <div class="h-bar">
      <div class="h-dh" style="width:${t.psych.dh}%"></div>
      <div class="h-mh" style="width:${t.psych.mh}%"></div>
      <div class="h-ph" style="width:${t.psych.ph}%"></div>
    </div>
    <div style="display:flex;justify-content:space-between;font-family:'DM Mono',monospace;font-size:7px;color:var(--text2);margin-bottom:3px">
      <span style="color:var(--green)">üíé ${t.psych.dh}%</span>
      <span style="color:var(--yellow)">‚öñÔ∏è ${t.psych.mh}%</span>
      <span style="color:var(--red)">üìÑ ${t.psych.ph}%</span>
    </div>
    <div class="h-verdict" style="color:${t.psych.color}">${t.psych.verdict}</div>
    <div class="h-desc">${t.psych.desc}</div>
  </div>

  <!-- ACCUMULATION -->
  ${t.accum?.phase !== 'NONE' ? `
  <div style="padding:6px 8px;border-radius:5px;background:rgba(0,229,255,0.03);border:1px solid rgba(0,229,255,0.18);margin-bottom:6px;">
    <div style="font-family:'DM Mono',monospace;font-size:8px;font-weight:700;color:${t.accum.color}">${t.accum.label}</div>
    <div style="font-family:'DM Mono',monospace;font-size:8px;color:var(--text3);margin-top:2px;line-height:1.4">${t.accum.desc}</div>
  </div>` : ''}

  <!-- SIGNAL TAGS -->
  <div class="sigs">
    ${cgListed ? '<span class="sig s-cg">ü¶é CG LISTED</span>' : ''}
    ${t.xInfo?.active ? '<span class="sig s-x">ùïè X ACTIVE</span>' : ''}
    ${t.psych.dh>=55 ? '<span class="sig s-hold">üíé DIAMOND HANDS</span>' : ''}
    ${t.accum?.phase==='ACCUMULATION' ? '<span class="sig s-acc">üîÑ ACCUMULATING</span>' : ''}
    ${t.b1h>t.s1h ? '<span class="sig s-vol">üìà More Buyers</span>' : ''}
    ${t.boosts>0 ? `<span class="sig s-dex">üî• ${t.boosts} Boosts</span>` : ''}
    <span class="sig s-wave">${t.upsideToPeak}x to prev peak</span>
    ${t.ch1 > 0 ? '<span class="sig s-acc">üìà Price Recovering</span>' : ''}
    ${t.holders>=500 ? `<span class="sig s-hold">üë• ${t.holders}+ holders</span>` : ''}
  </div>

  <!-- TIMING -->
  <div class="t-box tb-${t.timing.cls}">
    <div style="font-size:15px">${t.timing.cls==='g'?'‚úÖ':t.timing.cls==='w'?'‚ö†Ô∏è':'üî¥'}</div>
    <div style="flex:1">
      <div class="t-action" style="color:${timingColor}">${t.timing.action}</div>
      <div class="t-reason">${t.timing.reason}</div>
    </div>
  </div>

  <!-- POSITION -->
  <div class="pos-box">
    <span class="pos-l">üíº Suggested Position:</span>
    <span class="pos-v" style="color:${t.pos.color}">${t.pos.pct} ‚Äî ${t.pos.label}</span>
  </div>

  <!-- LINKS -->
  <div class="links-row">
    <a class="lnk lnk-pump" href="https://pump.fun/coin/${t.addr}" target="_blank">üî• Pump</a>
    <a class="lnk" href="https://birdeye.so/token/${t.addr}" target="_blank">ü¶Ö Birdeye</a>
    <a class="lnk" href="https://solscan.io/token/${t.addr}" target="_blank">üîç Solscan</a>
    <a class="lnk" href="https://rugcheck.xyz/tokens/${t.addr}" target="_blank">üõ°Ô∏è Rug</a>
    ${t.twitter ? `<a class="lnk lnk-x" href="${t.twitter}" target="_blank">ùïè Twitter</a>` : ''}
    ${t.telegram ? `<a class="lnk" href="${t.telegram}" target="_blank">üí¨ TG</a>` : ''}
    ${cgListed && t.cgData.cgId ? `<a class="lnk lnk-cg" href="https://coingecko.com/en/coins/${t.cgData.cgId}" target="_blank">ü¶é CoinGecko</a>` : ''}
  </div>`;
}

function genBars(dropPct) {
  const bars = [];
  // Build up phase
  for(let i=0;i<5;i++) bars.push(10+i*18);
  // Peak
  bars.push(95, 90);
  // Dump phase
  const bottom = Math.max(8, Math.round(95 * (1 - dropPct/100)));
  bars.push(70, 48, 30, bottom+6, bottom+2, bottom, bottom+4, bottom+8);
  return bars;
}

// ============================================================
// SUMMARY
// ============================================================
function updateSummary() {
  const total   = tokens.length;
  const enter   = tokens.filter(t => t.timing.cls === 'g').length;
  const watch   = tokens.filter(t => t.timing.cls === 'w').length;
  const cg      = tokens.filter(t => t.cgData?.listed).length;
  const xact    = tokens.filter(t => t.xInfo?.active).length;
  const avgDrop = total ? Math.round(tokens.reduce((a,t)=>a+t.dropPct,0)/total) : 0;
  const avgUp   = total ? (tokens.reduce((a,t)=>a+t.upsideToPeak,0)/total).toFixed(1) : '--';

  document.getElementById('sumTotal').textContent   = total;
  document.getElementById('sumEnter').textContent   = enter;
  document.getElementById('sumWatch').textContent   = watch;
  document.getElementById('sumCg').textContent      = cg;
  document.getElementById('sumX').textContent       = xact;
  document.getElementById('sumAvgDrop').textContent = '-'+avgDrop+'%';
  document.getElementById('sumAvgUpside').textContent = avgUp+'x';
  document.getElementById('waveCount').textContent  = total;
  document.getElementById('foundCt').textContent    = total + ' setups';
  document.getElementById('cgCt').textContent       = cg;
  document.getElementById('xCt').textContent        = xact;
  document.getElementById('liveCount').textContent  = total + ' tokens';
}

// ============================================================
// DEMO TOKENS (shown when DexScreener unavailable)
// ============================================================
function demoTokens() {
  const make = (name, ticker, mc, peakMc, v24, ch24, ch1, ageH, holders, cgL, xA) => {
    const addr = 'DezXAZ8z7PnrnRJjz3wXBoRgixCa6xjnB7YaB1pPB263';
    const dropPct = Math.abs(Math.round(ch24));
    const upsideToPeak = Math.round(peakMc/mc);
    const psych = { dh:58, mh:28, ph:14, verdict:'üíé DIAMOND HANDS', color:'var(--green)', desc:'Holders not selling the dip ‚Äî strong conviction' };
    const accum = ch1 > 0 ? {phase:'ACCUMULATION',label:'üîÑ Accumulation Phase',desc:'Price stabilizing with steady buys.',color:'var(--green)'} : {phase:'NONE',label:'',desc:'',color:''};
    const cgData = cgL ? {listed:true,rank:4200,watchlist:1840,comScore:68,athPct:-92,cgId:'solana/'+addr} : {listed:false};
    const xInfo  = xA  ? {active:true,handle:ticker.toLowerCase(),url:'https://x.com/'+ticker.toLowerCase(),signal:'Volume active',score:3} : {active:false,handle:null,url:null};
    const t = {
      addr, name, ticker, logo:logo(name), mc, v24, v1h:Math.round(v24*0.08), v6h:Math.round(v24*0.22),
      liq:Math.round(mc*0.8), ch24, ch6:Math.round(ch24*0.3), ch1,
      b1h:42, s1h:28, b24:380, s24:210, ageH, ageLabel:ageH<48?ageH+'h':Math.round(ageH/24)+'d',
      estimatedPeakMC:peakMc, dropPct, upsideToPeak, holders,
      boosts: xA ? 2 : 0, twitter:'https://x.com/'+ticker.toLowerCase(), telegram:'https://t.me/'+ticker.toLowerCase(),
      dexUrl:`https://dexscreener.com/solana/${addr}`,
      addrShort: addr.slice(0,6)+'...'+addr.slice(-6),
      xInfo, cgData, psych, accum,
    };
    const { score, cat } = scoreToken(t);
    t.score = score; t.cat = cat;
    t.timing = getTiming({ accum:accum.phase==='ACCUMULATION', diamondH:true, cgListed:cgL, xActive:xA });
    t.pos = posSize(score, cgL, xA, accum.phase==='ACCUMULATION');
    return t;
  };
  return [
    make('Fwog', 'FWOG',   38000, 920000, 88000,  -96, 4,  18, 820, true,  true),
    make('AIDog','AIDOG',  22000, 950000, 62000,  -98, 2,  36, 450, true,  true),
    make('Ribbit','RIBBIT',45000, 880000, 140000, -95,-1,  72, 1200,true,  true),
    make('ChadSol','CHAD', 12000, 910000, 35000,  -99, 6,  9,  310, false, true),
    make('SolPepe','SPEPE',28000, 860000, 77000,  -97, 0,  144,680, true,  false),
  ];
}

// ============================================================
// UTILS
// ============================================================
function copyCA(addr, btn) {
  navigator.clipboard.writeText(addr).catch(()=>{});
  const orig = btn.textContent || btn.innerHTML;
  if(btn.tagName === 'BUTTON') { btn.textContent = '‚úì Copied!'; setTimeout(()=>btn.textContent=orig, 1500); }
  else { btn.textContent = '‚úì Copied!'; setTimeout(()=>btn.textContent=addr.slice(0,6)+'...'+addr.slice(-6), 1500); }
}

function setFilter(f, btn) {
  activeFilter = f;
  document.querySelectorAll('.fb').forEach(b => b.classList.remove('act'));
  btn.classList.add('act');
  renderGrid();
}

function doRefresh() {
  cdSecs = CFG.REFRESH_SECS;
  fetchMarket();
  fetchTokens();
}

// ============================================================
// COUNTDOWN
// ============================================================
setInterval(() => {
  cdSecs--;
  const m = Math.floor(cdSecs/60), s = cdSecs%60;
  const el = document.getElementById('cdTimer');
  if(el) el.textContent = m+':'+(s<10?'0':'')+s;
  const lt = document.getElementById('localTime');
  if(lt) lt.textContent = new Date().toLocaleTimeString();
  if(cdSecs <= 0) { cdSecs = CFG.REFRESH_SECS; doRefresh(); }
}, 1000);

// ============================================================
// INIT
// ============================================================
fetchMarket();
fetchTokens();
</script>
</body>
</html>
